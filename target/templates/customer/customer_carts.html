{% extends "customer/customer_base.html" %}

{% block title %}Cart{% endblock %}

{% block content %}
<h1>Your Cart</h1>

{% if cart_items %}
    <table id="cart-table">
        <thead>
            <tr>
                <th>Image</th>
                <th>Product Name</th>
                <th>Brand</th>
                <th>Category</th>
                <th>Price</th>
                <th>Discount</th>
                <th>Quantity</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for index, item in enumerate(cart_items) %}
                <tr data-price="{{ item['price'] }}" data-discount="{{ item['discount'] }}">
                    <td><img src="{{ url_for('static', filename='images/' + item['image1']) }}" alt="Product Image" width="100"></td>
                    <td>{{ item['product_name'] }}</td>
                    <td>{{ item['product_brand'] }}</td>
                    <td>{{ item['product_category'] }}</td>
                    <td class="price">Rs.{{ item['price'] -(item['price']*(item['discount']/100))}}</td>
                    <td>{{ item['discount'] }}%</td>
                    <td>
                        <select name="quantity" class="quantity-dropdown">
                            {% for i in range(1, 11) %}
                                <option value="{{ i }}" {% if item['quantity'] == i %}selected{% endif %}>{{ i }}</option>
                            {% endfor %}
                        </select>
                    </td>
                    <td>
                        <form action="{{ url_for('customer.delete_from_cart', index=index) }}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger">Delete</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
            <!-- Row for Total Price -->
            <tr>
                <td colspan="7" style="text-align:right;"><strong>Total Price:</strong></td>
                <td id="total-price">{{ grand_total }}</td>
            </tr>
        </tbody>
    </table>

    <form action="{{ url_for('customer.submit_cart') }}" method="POST">
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>


{% else %}
    <p>Your cart is empty.</p>
{% endif %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const quantityDropdowns = document.querySelectorAll('.quantity-dropdown');
    const totalPriceElement = document.getElementById('total-price');
    const cartRows = document.querySelectorAll('#cart-table tbody tr');

    function updateTotalPrice() {
        console.log('Updating total price...'); // Debugging line
        let totalPrice = 0;

        cartRows.forEach(row => {
            const price = parseFloat(row.dataset.price);
            const discount = parseFloat(row.dataset.discount);
            const dropdown = row.querySelector('.quantity-dropdown');

            if (dropdown) {
                const quantity = parseFloat(dropdown.value);
                const discountedPrice = price - (price * discount / 100);
                totalPrice += discountedPrice * quantity;
            } else {
                console.warn('Dropdown not found in row:', row);
            }
        });

        totalPriceElement.textContent = `Rs.${totalPrice.toFixed(2)}`;
    }

    quantityDropdowns.forEach(dropdown => {
        dropdown.addEventListener('change', (event) => {
            const rowIndex = Array.from(dropdown.parentNode.parentNode.parentNode.children).indexOf(dropdown.parentNode.parentNode);
            fetch('http://20.157.92.44/customer/update_quantity', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ index: rowIndex, quantity: dropdown.value })
            }).then(response => {
                if (response.ok) {
                    updateTotalPrice();
                } else {
                    console.error('Failed to update quantity');
                }
            });
        });
    });

    updateTotalPrice();
});
</script>
{% endblock %}

{% endblock %}
